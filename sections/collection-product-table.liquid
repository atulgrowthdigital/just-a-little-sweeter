<section class="collection-product-table">
  {% comment %}
    If a collection is selected in settings, use it.
    Otherwise, use the current collection page's collection.
  {% endcomment %}
  {% if section.settings.collection != blank %}
    {% assign selected_collection = collections[section.settings.collection] %}
  {% elsif collection %}
    {% assign selected_collection = collection %}
  {% endif %}

  {% if selected_collection %}
    <h2>{{ selected_collection.title }}</h2>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Product Title</th>
            <th>Product URL</th>
            <th>Product ID</th>
            {% comment %} <th>Variant IDs</th> {% endcomment %}
            <th>Tags</th>
            <th>Collections</th>
            <th>Image URL</th>
            <th>Image Name</th>
            <th>Image Format</th>
          </tr>
        </thead>

        <tbody>
          {% for product in selected_collection.products %}
            <tr>
              <td>{{ forloop.index }}</td>
              <td>{{ product.title }}</td>
              <td>
                <a href="{{ product.url }}" target="_blank">{{ product.url }}</a>
              </td>
              <td>
                <a href="https://admin.shopify.com/store/qwt94e/products/{{ product.id }}" target="_blank">
                  {{ product.id }}
                </a>
              </td>
              {% comment %} <td>
                {% for variant in product.variants %}
                  {{ variant.id -}}
                  {%- unless forloop.last %}, {% endunless %}
                {% endfor %}
              </td> {% endcomment %}

              <!-- ✅ Product Tags -->
              <td>
                {% if product.tags.size > 0 %}
                  <ul>
                    {% for tag in product.tags %}
                      <li>
                        {{ tag }}
                        {% unless forloop.last %}<br>{% endunless %}
                      </li>
                    {% endfor %}
                  </ul>
                  {% comment %} {{ product.tags | join: ', ' }} {% endcomment %}
                {% else %}
                  No Tags
                {% endif %}
              </td>

              <!-- ✅ Product belongs to these Collections -->
              <td>
                {% if product.collections.size > 0 %}
                  {% for coll in product.collections %}
                    <a href="{{ coll.url }}" target="_blank">{{ coll.title }}</a>
                    {% unless forloop.last %}<br>{% endunless %}
                  {% endfor %}
                {% else %}
                  No Collections
                {% endif %}
              </td>

              <!-- Product Images -->
              <td>
                {% if product.images.size > 0 %}
                  {% for image in product.images %}
                    <a href="{{ image.src | img_url: 'master' }}" target="_blank">{{ image.src }}</a>
                    <img src="{{ image.src | img_url: 'master' }}" />
                    {% unless forloop.last %}<br>{% endunless %}
                  {% endfor %}
                {% else %}
                  No Images
                {% endif %}
              </td>

              <!-- Image Name -->
              <td>
                {% if product.images.size > 0 %}
                  {% for image in product.images %}
                    {% assign img_last = image.src | split: '/' | last %}
                    {% assign img_clean = img_last | split: '?' | first %}
                    {% assign name_without_ext = img_clean
                      | replace: '.jpg', ''
                      | replace: '.jpeg', ''
                      | replace: '.png', ''
                      | replace: '.webp', ''
                      | replace: '.gif', ''
                    %}
                    <a
                      href="https://admin.shopify.com/store/qwt94e/content/files?query={{ name_without_ext }}"
                      target="_blank"
                    >
                      {{ name_without_ext }}
                    </a>
                    {% unless forloop.last %}<br>{% endunless %}
                  {% endfor %}
                {% endif %}
              </td>

              <!-- Image Format -->
              <td>
                {% if product.images.size > 0 %}
                  {% for image in product.images %}
                    {{ image.src | split: '.' | last | split: '?' | first }}
                    {% unless forloop.last %}<br>{% endunless %}
                  {% endfor %}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>No collection selected and no default collection available.</p>
  {% endif %}
</section>

<style>
  .collection-product-table h2 {
    margin-bottom: 15px;
  }

  .table-wrapper {
    width: 100%;
    overflow-x: auto;
    border: 1px solid #ddd;
    {% comment %} max-height: 1500px; {% endcomment %}
    overflow-y: auto;
  }

  .collection-product-table table {
    width: 100%;
    border-collapse: collapse;
  }

  .collection-product-table th,
  .collection-product-table td {
    border: 1px solid #ddd;
    padding: 8px;
    font-size: 14px;
    word-break: break-all;
  }

  .collection-product-table thead th {
    position: sticky;
    top: 0;
    background: #f5f5f5;
    z-index: 2;
  }
</style>

{% schema %}
{
  "name": "Collection Product Table",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Select Collection"
    }
  ],
  "presets": [
    {
      "name": "Collection Product Table"
    }
  ]
}
{% endschema %}
